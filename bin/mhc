#!/usr/bin/env ruby

require "pp"
require "shellwords"

if File.symlink?(__FILE__) and ENV["RBENV_VERSION"]
  ENV["RBENV_VERSION"] = nil
  shims_path = File.expand_path("shims", ENV["RBENV_ROOT"])
  ENV["PATH"] = shims_path + ":" + ENV["PATH"]
  exec(File.readlink(__FILE__), *ARGV)
end

ENV["BUNDLE_GEMFILE"] = File.expand_path("../../Gemfile", __FILE__)

require 'rubygems'
require 'bundler/setup'
# Bundler.require
require "mhc"
require "mhc/command/scan"
require "mhc/command/sync"
require "thor"

Dir.glob(File.expand_path("~/.mhc/plugins/*.rb")) do |rb|
  require rb
end

Encoding.default_external="UTF-8"

class MhcCLI < Thor
  DEFAULT_CONFIG_PATH = "~/.mhc/config.yml"

  class << self
    attr_accessor :calendar
  end

  check_unknown_options!
  package_name 'MHC'

  class_option :repository, :desc => "Set MHC top directory"
  class_option :config, :desc => "Set config path (default: #{DEFAULT_CONFIG_PATH})"
  map ["--version", "-v"] => :version

  default_command :help
  map ["--help", "-h"] => :help

  desc "version", "Show version"
  def version
    puts Mhc::VERSION
  end

  desc "scan RANGE", "Scan events in date RANGE"
  long_desc <<-LONGDESC
    scan events in date RANGE.

    RANGE is one of:
    \x5 + START-YYYYMMDD
    \x5 + START[+LENGTH]

    START is one of:
    \x5 + today, tomorrow, sun ... sat, yyyymmdd
    \x5 + thismonth, nextmonth, yyyymm

    LENGTH is a number followed by a SUFFIX. SUFFIX is one of:
    \x5 + d (days)
    \x5 + w (weeks)
    \x5 + m (months)

    If LENGTH is omitted, it is treated as '1d' or '1m' depending on
    which type of START is set.

    Examples:
    \x5 mhc scan 20140101-20141231
    \x5 mhc scan 2140101+3d
    \x5 mhc scan today --category 'Business'
    \x5 mhc scan thismonth --search 'category:Business & !subject:"Trip"'
  LONGDESC
  method_option :calendar, :desc => "Set source CALENDAR"
  method_option :category, :desc => "Pick items only in CATEGORY"
  method_option :format,   :desc => "Set printing format (text, icalendar,...)"
  method_option :search,   :desc => "Search items by complex expression"
  def scan(range)
    begin
      Mhc::Command::Scan.new(calendar, range, **symbolize_keys(options))
    rescue Mhc::PropertyValue::ParseError, Mhc::FormatterNameError, Mhc::Query::ParseError => e
      STDERR.print "Error: " + e.message + "\n"
    end
    return self
  end

  desc "server", "Invoked as server (backend of emacs)"
  def server
    while line = STDIN.gets # STDIN.noecho(&:gets)
      argv = line.chomp.shellsplit
      self.class.start(argv)
    end
  end

  desc "sync SYNC_CHANNEL", "Synchronize DBs via SYNC_CHANNEL"
  def sync(channel_name)
    driver = exit_on_error do
      builder.sync_driver(channel_name)
    end
    driver.sync_all
    return self
  end

  no_commands do
    def invoke_command(command, *args)
      setup_global_options
      super
    end
  end

  private

  def exit_on_error(&block)
    begin
      yield if block_given?
    rescue Mhc::ConfigurationError => e
      STDERR.print "ERROR: #{e.message}.\n"
      exit 1
    end
  end

  attr_reader :builder, :config, :calendar

  def setup_global_options
    exit_on_error do
      @config = Mhc::Config.create_from_file(options[:config] || DEFAULT_CONFIG_PATH)
      @builder ||= Mhc::Builder.new(@config)

      calname  = options[:calendar] || @config.calendars.first.name
      calendar = @config.calendars[calname]
      calendar.repository = options[:repository] if options[:repository]

      self.class.calendar ||= builder.calendar(calname)
      @calendar = self.class.calendar
    end
  end

  def symbolize_keys(hash)
    Hash[hash.map {|k,v| [k.to_sym, v]}]
  end
end

command = MhcCLI.start(ARGV)
